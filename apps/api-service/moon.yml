language: "typescript"
type: application

fileGroups:
  configs:
    - "package.json"
    - "tsconfig.json"
    - "eslint.config.mjs"
    - "nest-cli.json"
  sources:
    - "src/**/*"
  tests:
    - 'test/**/*'

tasks:
  build:
    command: 'pnpm run build'
    inputs:
      - '@files(sources)'
      - '@files(configs)'
    outputs:
      - 'dist'
    deps:
      - 'storage:build'
      - 'control:build'
  dev:
    command: 'docker compose up dev'
    deps:
      - 'build'
    local: true

  prod:
    command: 'pnpm run start:prod'
    deps:
      - 'build'
    local: true
  test:
    command: 'docker compose run --remove-orphans tests'
    inputs:
      - '@files(sources)'
      - '@files(configs)'
      - '@files(tests)'
    deps:
      - 'build'
  format:
    inputs:
      - '@files(configs)'
      - '@files(sources)'
    options:
      runInCI: false
    script: pnpm run format
    deps:
      - 'build'
  checkFormat:
    command: pnpm run format:check
    inputs:
      - '@files(configs)'
      - '@files(sources)'
  lint:
    inputs:
      - '@files(configs)'
      - '@files(sources)'
    script: pnpm run lint
    deps:
      - 'build'